<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>ì œí’ˆ ë“±ë¡ ë‚´ì—­ ì¡°íšŒ</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">
<style>
  :root { --ci-blue: #2f6286; --ci-green: #72bf44; --ci-dark: #231f20; --ci-white: #ffffff; }
  body, html { margin: 0; padding: 0; font-family: 'Noto Sans KR', sans-serif; background-color: #f5f7fa; -webkit-user-select:none; user-select:none; }
  .inquiry-container { max-width: 500px; margin: 40px auto; padding: 30px; background-color: var(--ci-white); border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
  .nav-header { display: flex; justify-content: flex-end; margin-bottom: 10px; }
  .home-btn { text-decoration: none; font-size: 13px; color: #888; font-weight: 500; display: flex; align-items: center; transition: color 0.3s; }
  .home-btn:hover { color: var(--ci-blue); }
  .inquiry-container h2 { text-align: center; margin-bottom: 10px; color: var(--ci-dark); font-size: 24px; font-weight: 800; }
  .sub-text { text-align: center; margin-bottom: 25px; font-size: 13px; color: #666; line-height: 1.5; }
  
  .kakao-btn-box { text-align: center; margin-bottom: 25px; }
  .kakao-btn { display: inline-block; background-color: #FEE500; color: #3c1e1e; padding: 12px 20px; border-radius: 8px; font-weight: bold; text-decoration: none; font-size: 14px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: transform 0.2s; }
  .kakao-btn:hover { transform: translateY(-2px); }

  .input-group { margin-bottom: 15px; }
  .input-group label { display: block; margin-bottom: 6px; font-weight: 700; font-size: 13px; color: #555; }
  .input-group input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 15px; box-sizing: border-box; transition: border 0.3s; }
  .input-group input:focus { border-color: var(--ci-blue); outline: none; }
  .search-btn { width: 100%; padding: 15px; background-color: var(--ci-white); color: var(--ci-dark); border: 1px solid #ddd; border-radius: 8px; font-weight: 800; cursor: pointer; font-size: 16px; margin-top: 10px; transition: all 0.3s ease; }
  .search-btn:hover { background-color: #f9fff9; border-color: var(--ci-green); color: var(--ci-green); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(114, 191, 68, 0.2); }
  
  .loading-container { display: none; flex-direction: column; align-items: center; justify-content: center; margin-top: 15px; background-color: #f8f9fa; padding: 20px; border-radius: 8px; }
  .spinner { border: 3px solid #f3f3f3; border-top: 3px solid var(--ci-blue); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin-bottom: 8px; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  .loading-msg { font-size: 13px; font-weight: bold; color: var(--ci-dark); }
  .wait-msg { font-size: 11px; color: #666; margin-top: 3px; }

  #resultContainer { margin-top: 30px; display: flex; flex-direction: column; gap: 25px; }
  .result-card { background-color: #fff; border: 1px solid #eef2f5; border-radius: 12px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: relative; transition: transform 0.2s; }
  .result-card:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); border-color: var(--ci-blue); }
  .index-badge { position: absolute; top: 20px; right: 20px; background-color: #f0f4f8; color: var(--ci-blue); font-size: 11px; padding: 4px 8px; border-radius: 6px; font-weight: bold; }
  .status-badge { display: inline-block; padding: 5px 12px; background-color: var(--ci-green); color: white; font-size: 12px; font-weight: bold; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(114, 191, 68, 0.3); }
  .info-row { display: flex; justify-content: space-between; margin-bottom: 12px; border-bottom: 1px dashed #eee; padding-bottom: 8px; font-size: 14px; }
  .info-row:last-child { border-bottom: none; }
  .info-label { color: #888; font-weight: 500; }
  .info-value { color: var(--ci-dark); font-weight: 700; text-align: right; }
  .warranty-section { margin-top: 15px; padding-top: 15px; border-top: 2px solid #eee; }
  .warranty-title { font-size: 14px; font-weight: 800; color: var(--ci-dark); margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; }
  .year-badge { font-size: 11px; background-color: var(--ci-dark); color: #fff; padding: 3px 8px; border-radius: 4px; font-weight: normal; }
  .warranty-box { background-color: #f9f9f9; border: 1px solid #eee; border-radius: 6px; padding: 15px; }
  .warranty-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px; }
  .w-item strong { color: var(--ci-blue); }
  .receipt-note { grid-column: span 2; font-size: 11px; color: var(--ci-blue); font-weight: bold; margin-top: 8px; border-top: 1px solid #eee; padding-top: 8px; text-align: center; }
  
  /* ë§ˆì¼€íŒ… ì„¤ì • ì„¹ì…˜ */
  .marketing-section { margin-top: 15px; padding: 12px; background-color: #f8faff; border-radius: 8px; border: 1px solid #e1e9f0; display: flex; align-items: center; justify-content: space-between; }
  .marketing-label { font-size: 13px; font-weight: bold; color: var(--ci-dark); display: flex; align-items: center; }
  .marketing-sub { font-size: 11px; color: #888; display: block; margin-top: 2px; }
  
  /* [NEW] ì•½ê´€ ì „ë¬¸ë³´ê¸° ë²„íŠ¼ */
  .view-term-btn { font-size: 11px; color: #888; background: #fff; border: 1px solid #ddd; border-radius: 4px; padding: 2px 6px; margin-left: 6px; cursor: pointer; letter-spacing: -0.5px; }
  .view-term-btn:hover { color: var(--ci-blue); border-color: var(--ci-blue); }

  /* í† ê¸€ ìŠ¤ìœ„ì¹˜ */
  .toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; }
  .toggle-switch input { opacity: 0; width: 0; height: 0; }
  .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
  .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
  input:checked + .slider { background-color: var(--ci-blue); }
  input:checked + .slider:before { transform: translateX(20px); }
  input:disabled + .slider { opacity: 0.5; cursor: not-allowed; }

  /* ëª¨ë‹¬ íŒì—… ìŠ¤íƒ€ì¼ (NEW) */
  .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; }
  .modal-box { background: white; width: 90%; max-width: 500px; max-height: 80vh; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 5px 30px rgba(0,0,0,0.3); }
  .modal-header { padding: 15px; background: #f0f4f8; border-bottom: 1px solid #eee; font-weight: bold; color: var(--ci-dark); display: flex; justify-content: space-between; align-items: center; }
  .modal-close { background: none; border: none; font-size: 20px; cursor: pointer; color: #666; }
  .modal-content { padding: 20px; overflow-y: auto; font-size: 13px; line-height: 1.6; color: #444; white-space: pre-wrap; }
  .modal-footer { padding: 15px; border-top: 1px solid #eee; text-align: center; }
  .modal-btn { background: var(--ci-blue); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }

  .promo-link { display: block; margin-top: 15px; padding: 12px; background-color: #e67e22; color: white; text-align: center; text-decoration: none; font-weight: bold; border-radius: 6px; font-size: 14px; cursor: pointer; animation: pulse 2s infinite; }
  @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(230, 126, 34, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(230, 126, 34, 0); } 100% { box-shadow: 0 0 0 0 rgba(230, 126, 34, 0); } }

  .message-box { text-align: center; padding: 20px; color: #666; font-size: 14px; display: none; margin-top: 10px; }
  .error-text { color: #e74c3c; font-weight: bold; }
  .count-msg { text-align: center; font-size: 15px; font-weight: 800; color: var(--ci-dark); margin-bottom: 10px; display: none; padding: 10px; background-color: #f0f4f8; border-radius: 8px; }
  .footer-logo { text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px dashed #eee; }
  .footer-logo img { height: 24px; opacity: 0.8; }
  @media (max-width: 500px) { .inquiry-container { margin: 15px; padding: 20px; } }
</style>
</head>
<body oncontextmenu="return false" ondragstart="return false" onselectstart="return false">

<div class="inquiry-container">
  <div class="nav-header"><a href="./main.html" class="home-btn">ğŸ  ë©”ì¸ìœ¼ë¡œ</a></div>
  <h2>ì œí’ˆ ë“±ë¡ ì¡°íšŒ</h2>
  <div class="sub-text">ë“±ë¡ëœ <b>ì´ë¦„ê³¼ ì—°ë½ì²˜</b>ë¥¼ ì…ë ¥í•˜ì‹œë©´<br>ë“±ë¡ ë‚´ì—­ê³¼ ì°¨ëŒ€ë²ˆí˜¸ë¥¼ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>

  <div class="kakao-btn-box">
    <a href="https://pf.kakao.com/_xxxxxxx" target="_blank" class="kakao-btn">ğŸ’¬ í€„ë¦¬ìŠ¤í¬ì¸  ì¹´í†¡ ì±„ë„ ì¶”ê°€í•˜ê³  í˜œíƒë°›ê¸°</a>
  </div>

  <div class="input-group"><label>ì´ë¦„ (ë“±ë¡ìëª…)</label><input type="text" id="nameInput" placeholder="ì˜ˆ: í™ê¸¸ë™"></div>
  <div class="input-group"><label>ì—°ë½ì²˜</label><input type="text" id="phoneInput" placeholder="ì˜ˆ: 010-0000-0000" maxlength="13"></div>

  <button id="btnSearch" class="search-btn">ë‚´ì—­ ì¡°íšŒí•˜ê¸°</button>
  
  <div id="loadingArea" class="loading-container">
    <div class="spinner"></div>
    <span id="loadingText" class="loading-msg">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</span>
    <span id="waitText" class="wait-msg"></span>
  </div>

  <div id="msgBox" class="message-box"></div>
  <div id="countMsg" class="count-msg"></div>
  <div id="resultContainer"></div>
  <div class="footer-logo"><img src="https://via.placeholder.com/150x40/231f20/ffffff?text=QUALI+SPORTS" alt="QUALI SPORTS"></div>
</div>

<div id="modalMarketing" class="modal-overlay" onclick="closeModal('modalMarketing')">
  <div class="modal-box" onclick="event.stopPropagation()">
    <div class="modal-header">ë§ˆì¼€íŒ… ì •ë³´ ìˆ˜ì‹  ë™ì˜ <button class="modal-close" onclick="closeModal('modalMarketing')">&times;</button></div>
    <div class="modal-content">
      1. ì‹ ì œí’ˆ ì¶œì‹œ ì†Œì‹, í• ì¸ í”„ë¡œëª¨ì…˜, ì´ë²¤íŠ¸ í˜œíƒ ë“± ë‹¤ì–‘í•œ ì •ë³´ë¥¼ SMS, ì•Œë¦¼í†¡ ë“±ìœ¼ë¡œ ë°›ì•„ë³´ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br><br>
      2. ë™ì˜í•˜ì§€ ì•Šìœ¼ì…”ë„ ì •í’ˆ ë“±ë¡ ì„œë¹„ìŠ¤ ì´ìš©ì—ëŠ” ì œí•œì´ ì—†ìŠµë‹ˆë‹¤.<br><br>
      3. ë³´ìœ  ê¸°ê°„: íšŒì› íƒˆí‡´ ì‹œ ë˜ëŠ” ë™ì˜ ì² íšŒ ì‹œê¹Œì§€
    </div>
    <div class="modal-footer"><button class="modal-btn" onclick="closeModal('modalMarketing')">í™•ì¸</button></div>
  </div>
</div>

<script>
  const GAS_URL = "https://script.google.com/macros/s/AKfycbyy02EOo87dG4BWco1kbLO3O9BXwFSUKy-olHVwUim_E_07Azl5tl-e40UO1uBqoyeJ/exec"; 

  // ëª¨ë‹¬ ê¸°ëŠ¥ (New)
  function openModal(id) { document.getElementById(id).style.display = 'flex'; }
  function closeModal(id) { document.getElementById(id).style.display = 'none'; }

  async function fetchWithRetry(url, options = {}, retries = 3, backoff = 1000) {
    try {
      const response = await fetch(url, options);
      if (!response.ok) throw new Error("Server Busy");
      const json = await response.json();
      return json;
    } catch (error) {
      if (retries > 0) {
        const waitText = document.getElementById("waitText");
        if(waitText) waitText.innerText = `ì ‘ì†ëŸ‰ì´ ë§ì•„ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤... (${retries})`;
        await new Promise(resolve => setTimeout(resolve, backoff));
        return fetchWithRetry(url, options, retries - 1, backoff * 2);
      } else { throw error; }
    }
  }

  document.addEventListener("DOMContentLoaded", function() {
      const btnSearch = document.getElementById("btnSearch");
      const nameInput = document.getElementById("nameInput");
      const phoneInput = document.getElementById("phoneInput");
      const resultContainer = document.getElementById("resultContainer");
      const msgBox = document.getElementById("msgBox");
      const countMsg = document.getElementById("countMsg");
      const loadingArea = document.getElementById("loadingArea");

      if(btnSearch) btnSearch.addEventListener("click", searchData);
      if(phoneInput) phoneInput.addEventListener('input', function(e) {
        let val = e.target.value.replace(/[^0-9]/g, '');
        if (val.length > 3 && val.length <= 7) val = val.slice(0, 3) + "-" + val.slice(3); else if (val.length > 7) val = val.slice(0, 3) + "-" + val.slice(3, 7) + "-" + val.slice(7);
        e.target.value = val.slice(0, 13);
      });

      const urlParams = new URLSearchParams(window.location.search);
      const pName = urlParams.get('name');
      const pPhone = urlParams.get('phone');
      if (pName && pPhone) { nameInput.value = pName; phoneInput.value = pPhone; setTimeout(searchData, 300); }

      function searchData() {
        const name = nameInput.value.trim(); const phone = phoneInput.value.trim();
        if (!name || !phone) return alert("ì´ë¦„ê³¼ ì—°ë½ì²˜ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");

        resultContainer.innerHTML = ""; countMsg.style.display = "none"; msgBox.style.display = "none"; 
        loadingArea.style.display = "flex"; document.getElementById("waitText").innerText = "";
        btnSearch.disabled = true; btnSearch.style.backgroundColor = "#eee";

        fetchWithRetry(GAS_URL + "?type=search&name=" + encodeURIComponent(name) + "&phone=" + encodeURIComponent(phone), {}, 3)
          .then(res => {
            loadingArea.style.display = "none"; 
            btnSearch.disabled = false; btnSearch.style.backgroundColor = "var(--ci-white)";

            if (res.status === "success") {
              const list = res.data;
              countMsg.style.display = "block"; countMsg.innerText = `ì´ ${list.length}ê±´ì˜ ë“±ë¡ ë‚´ì—­ì´ ìˆìŠµë‹ˆë‹¤.`;
              list.forEach((item, index) => createCard(item, list.length - index, list.length));
            } else { msgBox.style.display = "block"; msgBox.innerHTML = '<span class="error-text">âŒ ì¼ì¹˜í•˜ëŠ” ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</span>'; }
          })
          .catch(e => { 
            loadingArea.style.display = "none"; btnSearch.disabled = false; btnSearch.style.backgroundColor = "var(--ci-white)";
            msgBox.style.display = "block"; msgBox.innerHTML = '<span class="error-text">ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.<br>ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</span>'; 
          });
      }

      function createCard(data, index, total) {
        const year = data.year || "2026";
        const dateStr = formatDate(data.date);
        let tFrame="2ë…„", tMotor="1ë…„", tCont="6ê°œì›”";
        if (year === "2025") { tFrame="1ë…„"; tMotor="6ê°œì›”"; tCont="6ê°œì›”"; }

        const isMarketingOn = (data.marketing === "ë™ì˜í•¨");
        const switchId = `marketingSwitch_${data.id}`;

        let promoHTML = "";
        const regDate = new Date(data.date); const today = new Date();
        const diffDays = Math.ceil(Math.abs(today - regDate) / (1000 * 60 * 60 * 24)); 
        const HEAD_OFFICE_LINK = "https://myshop.com/special_event"; 

        if (year === "2026" && diffDays <= 14) {
          let targetLink = HEAD_OFFICE_LINK; 
          if (data.isCredit && data.storeLink) targetLink = data.storeLink;

          const btnId = `promoBtn_${data.id}`;
          promoHTML = `<div id="${btnId}" class="promo-link" data-link="${targetLink}">ğŸ‰ íŠ¹ë³„ êµ¬ë§¤ í˜œíƒ ë°”ë¡œê°€ê¸° (D-${15-diffDays})</div>`;
          
          setTimeout(() => {
            const btn = document.getElementById(btnId);
            if(btn) btn.addEventListener("click", function() { handlePromoClick(btn, data); });
          }, 0);
        }

        const cardHTML = `
          <div class="result-card">
            <span class="index-badge"># ${index} / ${total}</span>
            <div style="text-align:center;"><span class="status-badge">âœ… ì œí’ˆ ë“±ë¡ ì™„ë£Œ</span></div>
            <div class="info-row"><span class="info-label">ì œí’ˆëª…</span><span class="info-value">${data.product}</span></div>
            <div class="info-row"><span class="info-label">ì°¨ëŒ€ë²ˆí˜¸</span><span class="info-value" style="color:#e74c3c;">${data.serial}</span></div>
            <div class="info-row"><span class="info-label">ë“±ë¡ì¼ì</span><span class="info-value">${dateStr}</span></div>
            <div class="info-row"><span class="info-label">êµ¬ì…ë§¤ì¥</span><span class="info-value">${data.store}</span></div>
            <div class="warranty-section">
              <div class="warranty-title"><span>ğŸ›¡ï¸ ì œí’ˆ ë³´ì¦ ê¸°ê°„</span><span class="year-badge">${year}ë…„í˜•</span></div>
              <div class="warranty-box">
                <div class="warranty-grid">
                  <div class="w-item"><strong>í”„ë ˆì„:</strong> <span>${tFrame}</span></div>
                  <div class="w-item"><strong>ëª¨í„°:</strong> <span>${tMotor}</span></div>
                  <div class="w-item"><strong>ì»¨íŠ¸ë¡¤ëŸ¬:</strong> <span>${tCont}</span></div>
                  <div class="receipt-note">ğŸ’¡ ëª¨ë“  ë³´ì¦ì€ ì˜ìˆ˜ì¦ ë‚ ì§œ ê¸°ì¤€ì…ë‹ˆë‹¤.</div>
                </div>
              </div>
            </div>
            
            <div class="marketing-section">
              <div>
                <span class="marketing-label">
                  ğŸ”” ë§ˆì¼€íŒ… ì •ë³´ ìˆ˜ì‹ 
                  <button class="view-term-btn" onclick="openModal('modalMarketing')">ì•½ê´€ë³´ê¸°</button>
                </span>
                <span class="marketing-sub">ë‹¤ì–‘í•œ í˜œíƒ ì •ë³´ë¥¼ ë°›ìŠµë‹ˆë‹¤</span>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="${switchId}" ${isMarketingOn ? 'checked' : ''}>
                <span class="slider"></span>
              </label>
            </div>

            ${promoHTML}
          </div>
        `;
        resultContainer.insertAdjacentHTML('beforeend', cardHTML);

        setTimeout(() => {
          const switchEl = document.getElementById(switchId);
          if (switchEl) {
            switchEl.addEventListener('change', function() {
              toggleMarketing(this, data.id);
            });
          }
        }, 0);
      }

      function toggleMarketing(checkbox, regId) {
        const newStatus = checkbox.checked ? "ë™ì˜í•¨" : "ë™ì˜ì•ˆí•¨";
        checkbox.disabled = true; 

        fetchWithRetry(GAS_URL, {
          method: "POST",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify({ type: "update_marketing", regId: regId, newStatus: newStatus })
        }, 2, 500)
        .then(res => {
          checkbox.disabled = false;
          if (res.result === "success") {
            alert(`âœ… ë§ˆì¼€íŒ… ìˆ˜ì‹  ë™ì˜ê°€ '${newStatus}'ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
          } else {
            alert("ë³€ê²½ ì‹¤íŒ¨: " + res.message);
            checkbox.checked = !checkbox.checked; 
          }
        })
        .catch(e => {
          alert("ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          checkbox.disabled = false;
          checkbox.checked = !checkbox.checked;
        });
      }

      function handlePromoClick(btnElement, data) {
        const targetLink = btnElement.getAttribute("data-link");
        btnElement.innerText = "í˜œíƒ í˜ì´ì§€ë¡œ ì´ë™ ì¤‘... ğŸ”„";
        btnElement.style.backgroundColor = "#ccc";
        btnElement.style.pointerEvents = "none"; 

        const logData = {
          type: "log_click",
          name: data.name,
          phone: data.phone,
          regId: data.regId || data.id,
          storeName: data.store,
          storeCode: data.storeCode, 
          model: data.product
        };

        fetchWithRetry(GAS_URL, {
          method: "POST", headers: { "Content-Type": "text/plain;charset=utf-8" }, body: JSON.stringify(logData)
        }, 2, 500) 
        .then(() => { window.location.href = targetLink; })
        .catch(() => { window.location.href = targetLink; });
      }

      function formatDate(d) { if(!d) return "-"; const date = new Date(d); return date.getFullYear()+"-"+String(date.getMonth()+1).padStart(2,'0')+"-"+String(date.getDate()).padStart(2,'0'); }
  });
  document.addEventListener('keydown', function(e) { if (e.keyCode === 123 || (e.ctrlKey && e.shiftKey && e.keyCode === 73) || (e.ctrlKey && e.keyCode === 85)) { e.preventDefault(); return false; } });
</script>
</body>
</html>